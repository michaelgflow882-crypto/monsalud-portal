<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monsalud WiFi Hotspot</title>
  <!-- Flask static CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
</head>
<body>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="topbar">
    <div class="logo-text">Monsalud WiFi Hotspot</div>
    <div id="menuBtn" class="menu-btn">‚ò∞</div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SIDEBAR (LEFT SIDE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img id="fbPic" src="https://i.ibb.co/7G5N6hS/user.png" class="user-icon" alt="User">
      <div class="user-label" id="fbName">Logged in as User</div>
    </div>
    <ul class="side-list">
      <li onclick="location.href='/history'">üìú Voucher History</li>
      <li onclick="location.href='/device'">üì± My Device</li>
      <li onclick="location.href='/leaderboard'">üèÜ Leaderboard</li>
      <li onclick="openPoints()">‚≠ê My Points</li>
      <li onclick="scrollToSpin()">üé° Spin &amp; Win</li>
      <li onclick="location.href='/support'">üì© Contact Support</li>
    </ul>
  </aside>

  <div id="overlay" class="overlay"></div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HERO / INFO (RIGHT) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="hero">
    <div class="sub" id="greetingText">Good afternoon üå§Ô∏è</div>
    <div class="info-box">
      <div class="info-row"><strong id="cityText">Cebu City</strong></div>
      <div class="info-row" id="dateText">Sunday, November 30, 2025</div>
      <div class="info-row" id="timeText">09:54 PM</div>
      <div class="weather-row">
        <span>‚òÅÔ∏è</span>
        <span id="weatherText">-- ¬∞C ‚Äî Location loading‚Ä¶</span>
      </div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SLIDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="slider" id="slider">
    <figure class="slide active">
      <img src="https://i.postimg.cc/PxBqyD9L/MOALBOAL-REEF-20251109-221455-0000.jpg" alt="MOALBOAL REEF">
      <figcaption>üìç MOALBOAL REEF</figcaption>
    </figure>
    <figure class="slide">
      <img src="https://i.postimg.cc/LsJRWXzN/OSLOB-WHALE-SHARK-20251110-172755-0000.jpg" alt="OSLOB WHALE SHARK">
      <figcaption>üìç OSLOB WHALE SHARK</figcaption>
    </figure>
    <figure class="slide">
      <img src="https://i.postimg.cc/htJ5W75d/TOPS-20251110-172318-0000.jpg" alt="TOPS CEBU">
      <figcaption>üìç TOPS CEBU</figcaption>
    </figure>
    <figure class="slide">
      <img src="https://i.postimg.cc/jj7mNJ6s/10000-ROSES-20251110-170913-0000.jpg" alt="10000 Roses">
      <figcaption>üìç 10,000 Roses</figcaption>
    </figure>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VOUCHER ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="voucher">
    <input id="voucherInput" type="text" placeholder="Enter voucher code">
    <button id="connectBtn">Connect</button>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PRICING CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="pricing">
    <div class="card free" data-price="‚Ç±0" data-label="Free Wi-Fi ¬∑ 30 mins/day">
      <span>‚Ç±0</span>
      <small>Free Wi-Fi</small>
      <small>30 mins/day</small>
    </div>
    <div class="card blue" data-price="‚Ç±6" data-label="2 Hours ¬∑ With pause">
      <span>‚Ç±6</span>
      <small>2 Hours</small>
      <small>With pause</small>
    </div>
    <div class="card violet" data-price="‚Ç±12" data-label="5 Hours ¬∑ With pause">
      <span>‚Ç±12</span>
      <small>5 Hours</small>
      <small>With pause</small>
    </div>
    <div class="card gold" data-price="‚Ç±23" data-label="1 Day ¬∑ No pause">
      <span>‚Ç±23</span>
      <small>1 Day</small>
      <small>No pause</small>
    </div>
    <div class="card orange" data-price="‚Ç±50" data-label="3 Days ¬∑ No pause">
      <span>‚Ç±50</span>
      <small>3 Days</small>
      <small>No pause</small>
    </div>
    <div class="card silver" data-price="‚Ç±100" data-label="7 Days ¬∑ No pause">
      <span>‚Ç±100</span>
      <small>7 Days</small>
      <small>No pause</small>
    </div>
    <div class="card plum" data-price="‚Ç±200" data-label="14 Days ¬∑ No pause">
      <span>‚Ç±200</span>
      <small>14 Days</small>
      <small>No pause</small>
    </div>
    <div class="card sunny" data-price="‚Ç±400" data-label="30 Days ¬∑ No pause">
      <span>‚Ç±400</span>
      <small>30 Days</small>
      <small>No pause</small>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SPIN & WIN SECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="spin-section" id="spinSection">
    <h2>üé° Spin &amp; Win</h2>
    <p class="spin-desc">10 points = 1 spin (demo mode)</p>

    <div class="spin-wrapper">
      <canvas id="wheelCanvas" width="300" height="300"></canvas>
      <div class="pointer"></div>
    </div>

    <button id="spinBtn" class="spin-btn">Spin Now</button>
    <div id="spinStatus" class="spin-status"></div>
    <div id="spinsLeft" class="spin-status"></div>

    <button id="myPointsBtn" class="points-btn">My Points</button>

    <div class="last-spins-wrapper">
      <h4 style="margin:10px 0 4px;font-size:.9rem;opacity:.9;">Last spins</h4>
      <ul id="lastSpins" style="list-style:none;padding:0;margin:0;font-size:.85rem;opacity:.9;"></ul>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="powered">Powered by MG Wellness Tech ‚Äî Ireneo</div>
  </footer>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MY POINTS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="pointsModal" class="modal-layer">
    <div class="modal-backdrop"></div>
    <div class="modal-box">
      <h3>My Points</h3>
      <p><strong>Active points:</strong> <span id="activePoints">0</span></p>
      <p><strong>Total points (this year):</strong> <span id="totalPoints">0</span></p>
      <p class="modal-note">Resets automatically every January 1 ‚Ä¢ Frontend demo only</p>
      <div class="modal-actions">
        <button id="closePoints" class="btn-outline">Close</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PRICING MODAL (BUY / ENTER / CANCEL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="pricingModal" class="modal-layer">
    <div class="modal-backdrop"></div>
    <div class="modal-box">
      <h3 id="pmTitle">Voucher details</h3>
      <p id="pmDetails"></p>
      <p class="modal-note">Buy = go to payment (soon) ¬∑ Enter = focus voucher box.</p>
      <div class="modal-actions">
        <button id="pmCancel" class="btn-outline">Cancel</button>
        <button id="pmEnter" class="btn-primary">Enter</button>
        <button id="pmBuy" class="btn-danger">Buy</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SOUND EFFECTS (served by Flask static) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <audio id="sndTick"     src="{{ url_for('static', filename='sounds/tick.wav') }}" preload="auto"></audio>
  <audio id="sndWin"      src="{{ url_for('static', filename='sounds/win.wav') }}" preload="auto"></audio>
  <audio id="sndJackpot"  src="{{ url_for('static', filename='sounds/jackpot.wav') }}" preload="auto"></audio>
  <audio id="sndTryAgain" src="{{ url_for('static', filename='sounds/try_again.wav') }}" preload="auto"></audio>
  <audio id="sndEnd"      src="{{ url_for('static', filename='sounds/end.wav') }}" preload="auto"></audio>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ JAVASCRIPT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    /* ========== CONFIG: GOOGLE SHEETS WEBHOOK URL ========== */
    const SHEETS_WEBHOOK_URL =
      "https://script.google.com/macros/s/AKfycbwpwUw-6KavvX4OzhZlp07tq7yczgvwkmA1aXygq7JBzuHCqWBu_KoLsmXAGZyhmV3_5w/exec";

    /* ========== BASIC DOM REFERENCES ========== */
    const sidebar   = document.getElementById("sidebar");
    const overlay   = document.getElementById("overlay");
    const menuBtn   = document.getElementById("menuBtn");
    const fbNameEl  = document.getElementById("fbName");
    let   fbName    = fbNameEl ? fbNameEl.textContent.trim() : "Guest";

    function scrollToSpin(){
      const sec = document.getElementById("spinSection");
      if (sec) sec.scrollIntoView({ behavior:"smooth", block:"center" });
      // close sidebar on mobile
      sidebar.classList.remove("open");
      overlay.classList.remove("show");
      menuBtn.style.opacity = "1";
    }

    /* ========== SIDEBAR MENU ========== */
    menuBtn.onclick = () => {
      sidebar.classList.add("open");
      overlay.classList.add("show");
      menuBtn.style.opacity = "0";
    };
    overlay.onclick = () => {
      sidebar.classList.remove("open");
      overlay.classList.remove("show");
      menuBtn.style.opacity = "1";
    };

    /* ========== GREETING ========== */
    function updateGreeting(){
      const hour = new Date().getHours();
      const g = document.getElementById("greetingText");
      if(hour < 12) g.textContent = "Good morning ‚òÄÔ∏è";
      else if(hour < 17) g.textContent = "Good afternoon üå§Ô∏è";
      else if(hour < 20) g.textContent = "Good evening üåÜ";
      else g.textContent = "Good night üåô";
    }
    updateGreeting();
    setInterval(updateGreeting, 60_000);

    /* ========== CLOCK + DATE ========== */
    function updateClock(){
      const now = new Date();
      document.getElementById("dateText").textContent =
        now.toLocaleDateString("en-PH", {
          weekday:"long",
          month:"long",
          day:"numeric",
          year:"numeric"
        });
      document.getElementById("timeText").textContent =
        now.toLocaleTimeString("en-US", {
          hour:"2-digit",
          minute:"2-digit"
        });
    }
    updateClock();
    setInterval(updateClock, 1000);

    /* ========== WEATHER (OpenWeather with Cebu fallback) ========== */
    const WEATHER_KEY = "8310e25324f43d028f09f93bad3cdeaf";
    const FALLBACK_CITY = { name:"Cebu City", lat:10.3157, lon:123.8854 };

    function setWeatherText(text){
      const el = document.getElementById("weatherText");
      if (el) el.textContent = text;
    }

    function fetchWeather(lat, lon, label){
      fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_KEY}&units=metric`)
        .then(r => r.json())
        .then(d => {
          if (!d.main || !d.weather) {
            setWeatherText("‚Äî ¬∞C ‚Äî Weather unavailable");
            return;
          }
          const temp = d.main.temp;
          const w = d.weather[0];
          setWeatherText(`${temp.toFixed(1)}¬∞C ‚Äî ${w.description}`);
          if (label){
            const cityEl = document.getElementById("cityText");
            if (cityEl) cityEl.textContent = label;
          }
        })
        .catch(() => {
          setWeatherText("‚Äî ¬∞C ‚Äî Weather error");
        });
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          fetchWeather(pos.coords.latitude, pos.coords.longitude, "Your location");
        },
        err => {
          // Location denied or failed: fallback Cebu
          fetchWeather(FALLBACK_CITY.lat, FALLBACK_CITY.lon, "Cebu City");
        },
        { timeout: 7000 }
      );
    } else {
      fetchWeather(FALLBACK_CITY.lat, FALLBACK_CITY.lon, "Cebu City");
    }

    /* ========== SLIDESHOW ========== */
    const slides = document.querySelectorAll(".slide");
    let slideIndex = 0;
    function nextSlide(){
      if (!slides.length) return;
      slides[slideIndex].classList.remove("active");
      slideIndex = (slideIndex + 1) % slides.length;
      slides[slideIndex].classList.add("active");
    }
    setInterval(nextSlide, 4000);

    /* ========== POINTS STORAGE (ACTIVE + TOTAL) ========== */
    const YEAR_KEY   = "mg_points_year";
    const ACTIVE_KEY = "mg_active_points";
    const TOTAL_KEY  = "mg_total_points";

    function loadPoints(){
      const nowYear   = new Date().getFullYear();
      const savedYear = parseInt(localStorage.getItem(YEAR_KEY) || "0", 10);
      if(savedYear !== nowYear){
        localStorage.setItem(YEAR_KEY, nowYear.toString());
        localStorage.setItem(ACTIVE_KEY, "0");
        localStorage.setItem(TOTAL_KEY, "0");
      }
      return {
        active: parseInt(localStorage.getItem(ACTIVE_KEY) || "0", 10),
        total:  parseInt(localStorage.getItem(TOTAL_KEY)  || "0", 10)
      };
    }

    function savePoints(active, total){
      localStorage.setItem(ACTIVE_KEY, active.toString());
      localStorage.setItem(TOTAL_KEY,  total.toString());
    }

    function refreshPointsUI(){
      const pts = loadPoints();
      document.getElementById("activePoints").textContent = pts.active;
      document.getElementById("totalPoints").textContent  = pts.total;
    }

    let points = loadPoints();

    /* ========== MY POINTS MODAL ========== */
    const pointsModal  = document.getElementById("pointsModal");
    const myPointsBtn  = document.getElementById("myPointsBtn");
    const sideMyPoints = document.getElementById("sideMyPoints");
    const closePoints  = document.getElementById("closePoints");

    function openPoints(){
      points = loadPoints();
      refreshPointsUI();
      pointsModal.classList.add("show");
    }
    function closePointsModal(){
      pointsModal.classList.remove("show");
    }

    if (myPointsBtn)  myPointsBtn.onclick  = openPoints;
    if (sideMyPoints) sideMyPoints.onclick = openPoints;
    if (closePoints)  closePoints.onclick  = closePointsModal;
    if (pointsModal) {
      const mb = pointsModal.querySelector(".modal-backdrop");
      if (mb) mb.onclick = closePointsModal;
    }

    /* ========== PRICING MODAL (BUY / ENTER / CANCEL) ========== */
    const pricingModal = document.getElementById("pricingModal");
    const pmTitle      = document.getElementById("pmTitle");
    const pmDetails    = document.getElementById("pmDetails");
    const pmCancel     = document.getElementById("pmCancel");
    const pmEnter      = document.getElementById("pmEnter");
    const pmBuy        = document.getElementById("pmBuy");
    const voucherInput = document.getElementById("voucherInput");

    function openPricing(price, label){
      pmTitle.textContent   = `Plan ${price}`;
      pmDetails.textContent = label;
      pricingModal.classList.add("show");
    }
    function closePricing(){
      pricingModal.classList.remove("show");
    }

    document.querySelectorAll(".card").forEach(card=>{
      const price = card.dataset.price;
      const label = card.dataset.label;
      card.addEventListener("click", ()=>openPricing(price,label));
    });

    pmCancel.onclick = closePricing;
    pricingModal.querySelector(".modal-backdrop").onclick = closePricing;
    pmEnter.onclick = () => {
      closePricing();
      voucherInput.focus();
    };
    pmBuy.onclick = () => {
      alert("Buy flow / Xendit integration coming soon.");
    };

    /* ========== SPIN WHEEL (3D STYLE + SOUNDS) ========== */
    const canvas = document.getElementById("wheelCanvas");
    const ctx    = canvas.getContext("2d");
    const cw     = canvas.width;
    const ch     = canvas.height;
    const cx     = cw / 2;
    const cy     = ch / 2;

    const spinBtn    = document.getElementById("spinBtn");
    const spinStatus = document.getElementById("spinStatus");
    const spinsLeftEl= document.getElementById("spinsLeft");
    const lastSpinsEl= document.getElementById("lastSpins");

    const prizes = [
      "2 Hours",
      "5 Hours",
      "12 Hours",
      "TRY AGAIN",
      "+1 Point",
      "+2 Points",
      "+4 Points",
      "+8 Points"
    ];

    const sliceCount = prizes.length;
    const sliceAngle = (2 * Math.PI) / sliceCount;

    function drawWheel() {
      const colors = [
        "#ffeb3b", "#ff7043", "#29b6f6", "#ab47bc",
        "#66bb6a", "#ffca28", "#ef5350", "#26a69a"
      ];

      ctx.clearRect(0, 0, cw, ch);

      for (let i = 0; i < sliceCount; i++) {
        const start = i * sliceAngle;
        const end   = start + sliceAngle;

        const grad = ctx.createRadialGradient(cx, cy, 40, cx, cy, 140);
        grad.addColorStop(0, "rgba(255,255,255,0.9)");
        grad.addColorStop(0.3, colors[i % colors.length]);
        grad.addColorStop(1,   "#111827");

        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.fillStyle = grad;
        ctx.arc(cx, cy, 140, start, end);
        ctx.closePath();
        ctx.fill();

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(start + sliceAngle / 2);
        ctx.textAlign = "center";
        ctx.fillStyle = "#002b55";
        ctx.font = "bold 15px Arial";
        ctx.fillText(prizes[i], 90, 5);
        ctx.restore();
      }

      // center hub
      ctx.beginPath();
      ctx.arc(cx, cy, 40, 0, 2 * Math.PI);
      const hubGrad = ctx.createRadialGradient(cx, cy, 5, cx, cy, 40);
      hubGrad.addColorStop(0, "#ffffff");
      hubGrad.addColorStop(1, "#cfd8dc");
      ctx.fillStyle = hubGrad;
      ctx.fill();
    }
    drawWheel();

    /* ========== SOUND HELPERS ========== */
    const sndTick     = document.getElementById("sndTick");
    const sndWin      = document.getElementById("sndWin");
    const sndEnd      = document.getElementById("sndEnd");
    const sndTryAgain = document.getElementById("sndTryAgain");
    const sndJackpot  = document.getElementById("sndJackpot");

    function playSound(audioEl){
      if (!audioEl) return;
      try{
        audioEl.currentTime = 0;
        audioEl.play();
      }catch(e){
        console.warn("Audio blocked:", e);
      }
    }

    /* DAILY SPIN LIMIT (demo: 5/day) */
    const SPIN_DAY_KEY   = "mg_spin_day";
    const SPINS_TODAY_KEY= "mg_spins_today";
    const SPIN_LIMIT     = 5;

    function loadSpinsLeft(){
      const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
      const savedDay = localStorage.getItem(SPIN_DAY_KEY);
      if (savedDay !== today){
        localStorage.setItem(SPIN_DAY_KEY, today);
        localStorage.setItem(SPINS_TODAY_KEY, "0");
        return SPIN_LIMIT;
      }
      const used = parseInt(localStorage.getItem(SPINS_TODAY_KEY) || "0", 10);
      return Math.max(SPIN_LIMIT - used, 0);
    }
    function useOneSpin(){
      const today = new Date().toISOString().slice(0,10);
      const used  = parseInt(localStorage.getItem(SPINS_TODAY_KEY) || "0", 10) + 1;
      localStorage.setItem(SPIN_DAY_KEY, today);
      localStorage.setItem(SPINS_TODAY_KEY, used.toString());
    }

    function updateSpinsLeftUI(){
      const left = loadSpinsLeft();
      spinsLeftEl.textContent = `Spins left today: ${left}`;
    }
    updateSpinsLeftUI();

    /* LAST SPINS (local only) */
    function pushLastSpin(text){
      if (!lastSpinsEl) return;
      const now = new Date();
      const time = now.toLocaleTimeString("en-PH", {hour:"2-digit",minute:"2-digit"});
      const li = document.createElement("li");
      li.textContent = `${text}  (${time})`;
      lastSpinsEl.insertBefore(li, lastSpinsEl.firstChild);
      while (lastSpinsEl.children.length > 5){
        lastSpinsEl.removeChild(lastSpinsEl.lastChild);
      }
    }

    /* ========== SPIN LOGIC ‚Äì exact pointer mapping (deg only) ========== */
    let wheelRotation = 0;   // in degrees
    let spinning = false;

    spinBtn.onclick = () => {
      if (spinning) return;

      let left = loadSpinsLeft();
      if (left <= 0){
        spinStatus.textContent = "No spins left today (demo limit).";
        playSound(sndEnd);
        return;
      }

      spinning = true;
      spinBtn.disabled = true;

      spinStatus.textContent = "Spinning‚Ä¶";
      playSound(sndTick);  // immediate tick

      const idx      = Math.floor(Math.random() * sliceCount); // random prize index
      const extra    = 6;                                      // full spins
      const sliceDeg = 360 / sliceCount;

      // Pointer at TOP = 270¬∞
      const targetDeg = (sliceDeg * idx) + (sliceDeg / 2);
      const finalDeg  = (extra * 360) + 270 - targetDeg;

      wheelRotation += finalDeg;

      const spinMs = 4500;
      canvas.style.transition = `transform ${spinMs/1000}s cubic-bezier(0.12,0.6,0.1,1)`;
      canvas.style.transform  = `rotate(${wheelRotation}deg)`;

      // ticking while spinning
      let tickTimer = setInterval(() => {
        playSound(sndTick);
      }, 90);

      setTimeout(() => {
        clearInterval(tickTimer);

        const result = prizes[idx];
        spinStatus.textContent = "üéâ Result: " + result;

        // compute points
        let addPoints = 0;
        const match = result.match(/^\+(\d+)\s+Point/);
        if (match) {
          addPoints = parseInt(match[1], 10);
          points = loadPoints();
          points.active += addPoints;
          points.total  += addPoints;
          savePoints(points.active, points.total);
        }

        // Decide end sound
        if (result === "TRY AGAIN") {
          playSound(sndTryAgain);
        } else if (result === "12 Hours") {
          // jackpot = biggest prize
          playSound(sndJackpot);
        } else if (addPoints > 0) {
          playSound(sndWin);
        } else {
          playSound(sndEnd);
        }

        // tiny end click
        setTimeout(() => playSound(sndEnd), 250);

        // track spins + last spins
        useOneSpin();
        updateSpinsLeftUI();
        pushLastSpin(result + (addPoints ? ` (+${addPoints} pts)` : " (0 pts)"));

        // log to Google Sheets (backend)
        if (SHEETS_WEBHOOK_URL && SHEETS_WEBHOOK_URL.startsWith("http")) {
          const payload = {
            branch:        "Branch 1 - Cogon Pardo",
            source:        "spin",
            timestamp:     new Date().toISOString(),
            fb_name:       fbName,
            prize:         result,
            add_points:    addPoints,
            active_points: points.active,
            total_points:  points.total
          };
          logSpinToSheet(payload);
        }

        spinning = false;
        spinBtn.disabled = false;
      }, spinMs + 200);
    };

    /* ========== LOGGING FUNCTION ========== */
    function logSpinToSheet(data) {
      try {
        fetch(SHEETS_WEBHOOK_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
      } catch (e) {
        console.warn("Log error:", e);
      }
    }
  </script>
</body>
</html>
